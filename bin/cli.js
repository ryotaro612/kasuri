#!/usr/bin/env -S node --enable-source-maps
import{argv as ss}from"node:process";import{existsSync as ze,readFileSync as Ve}from"node:fs";import{parseArgs as Ge,parseEnv as Xe}from"node:util";function ue(e){let s=Ge({args:e,options:{port:{type:"string",short:"p",default:"36332"},env:{type:"string",short:"e",default:".env"},help:{type:"boolean",short:"h",default:!1}}}),r=s.values.env,i={};ze(r)&&(i=Qe(r));let n=null,o=process.env.ASHITABA_OIDC_CLIENT_ID??i.ASHITABA_OIDC_CLIENT_ID;o||(n="Environment variable ASHITABA_OIDC_CLIENT_ID must be defined.");let a=process.env.ASHITABA_OIDC_CLIENT_SECRET??i.ASHITABA_OIDC_CLIENT_SECRET;return a||(n="Environment variable ASHITABA_OIDC_CLIENT_SECRET must be defined."),{port:parseInt(s.values.port),oidcClientId:o??"",clientSecret:a??"",error:n,help:s.values.help}}function Qe(e){let t=Ve(e);return Xe(t.toString())}import{createServer as Zt}from"node:http";var T=class extends Error{};T.prototype.name="InvalidTokenError";function Ye(e){return decodeURIComponent(atob(e).replace(/(.)/g,(t,s)=>{let r=s.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function Ze(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return Ye(t)}catch{return atob(t)}}function pe(e,t){if(typeof e!="string")throw new T("Invalid token specified: must be a string");t||(t={});let s=t.header===!0?0:1,r=e.split(".")[s];if(typeof r!="string")throw new T(`Invalid token specified: missing part #${s+1}`);let i;try{i=Ze(r)}catch(n){throw new T(`Invalid token specified: invalid base64 for part #${s+1} (${n.message})`)}try{return JSON.parse(i)}catch(n){throw new T(`Invalid token specified: invalid json for part #${s+1} (${n.message})`)}}var et={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},v,y,W=(e=>(e[e.NONE=0]="NONE",e[e.ERROR=1]="ERROR",e[e.WARN=2]="WARN",e[e.INFO=3]="INFO",e[e.DEBUG=4]="DEBUG",e))(W||{});(e=>{function t(){v=3,y=et}e.reset=t;function s(i){if(!(0<=i&&i<=4))throw new Error("Invalid log level");v=i}e.setLevel=s;function r(i){y=i}e.setLogger=r})(W||(W={}));var u=class m{constructor(t){this._name=t}debug(...t){v>=4&&y.debug(m._format(this._name,this._method),...t)}info(...t){v>=3&&y.info(m._format(this._name,this._method),...t)}warn(...t){v>=2&&y.warn(m._format(this._name,this._method),...t)}error(...t){v>=1&&y.error(m._format(this._name,this._method),...t)}throw(t){throw this.error(t),t}create(t){let s=Object.create(this);return s._method=t,s.debug("begin"),s}static createStatic(t,s){let r=new m(`${t}.${s}`);return r.debug("begin"),r}static _format(t,s){let r=`[${t}]`;return s?`${r} ${s}:`:r}static debug(t,...s){v>=4&&y.debug(m._format(t),...s)}static info(t,...s){v>=3&&y.info(m._format(t),...s)}static warn(t,...s){v>=2&&y.warn(m._format(t),...s)}static error(t,...s){v>=1&&y.error(m._format(t),...s)}};W.reset();var L=class{static decode(e){try{return pe(e)}catch(t){throw u.error("JwtUtils.decode",t),t}}static async generateSignedJwt(e,t,s){let r=f.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),i=f.encodeBase64Url(new TextEncoder().encode(JSON.stringify(t))),n=`${r}.${i}`,o=await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},s,new TextEncoder().encode(n)),a=f.encodeBase64Url(new Uint8Array(o));return`${n}.${a}`}},tt="10000000-1000-4000-8000-100000000000",X=e=>btoa([...new Uint8Array(e)].map(t=>String.fromCharCode(t)).join("")),we=class S{static _randomWord(){let t=new Uint32Array(1);return crypto.getRandomValues(t),t[0]}static generateUUIDv4(){return tt.replace(/[018]/g,s=>(+s^S._randomWord()&15>>+s/4).toString(16)).replace(/-/g,"")}static generateCodeVerifier(){return S.generateUUIDv4()+S.generateUUIDv4()+S.generateUUIDv4()}static async generateCodeChallenge(t){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{let r=new TextEncoder().encode(t),i=await crypto.subtle.digest("SHA-256",r);return X(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(s){throw u.error("CryptoUtils.generateCodeChallenge",s),s}}static generateBasicAuth(t,s){let i=new TextEncoder().encode([t,s].join(":"));return X(i)}static async hash(t,s){let r=new TextEncoder().encode(s),i=await crypto.subtle.digest(t,r);return new Uint8Array(i)}static async customCalculateJwkThumbprint(t){let s;switch(t.kty){case"RSA":s={e:t.e,kty:t.kty,n:t.n};break;case"EC":s={crv:t.crv,kty:t.kty,x:t.x,y:t.y};break;case"OKP":s={crv:t.crv,kty:t.kty,x:t.x};break;case"oct":s={crv:t.k,kty:t.kty};break;default:throw new Error("Unknown jwk type")}let r=await S.hash("SHA-256",JSON.stringify(s));return S.encodeBase64Url(r)}static async generateDPoPProof({url:t,accessToken:s,httpMethod:r,keyPair:i,nonce:n}){let o,a,c={jti:window.crypto.randomUUID(),htm:r??"GET",htu:t,iat:Math.floor(Date.now()/1e3)};s&&(o=await S.hash("SHA-256",s),a=S.encodeBase64Url(o),c.ath=a),n&&(c.nonce=n);try{let l=await crypto.subtle.exportKey("jwk",i.publicKey),d={alg:"ES256",typ:"dpop+jwt",jwk:{crv:l.crv,kty:l.kty,x:l.x,y:l.y}};return await L.generateSignedJwt(d,c,i.privateKey)}catch(l){throw l instanceof TypeError?new Error(`Error exporting dpop public key: ${l.message}`):l}}static async generateDPoPJkt(t){try{let s=await crypto.subtle.exportKey("jwk",t.publicKey);return await S.customCalculateJwkThumbprint(s)}catch(s){throw s instanceof TypeError?new Error(`Could not retrieve dpop keys from storage: ${s.message}`):s}}static async generateDPoPKeys(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"])}};we.encodeBase64Url=e=>X(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");var f=we,st=class{constructor(e){this._name=e,this._callbacks=[],this._logger=new u(`Event('${this._name}')`)}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){let t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){this._logger.debug("raise:",...e);for(let t of this._callbacks)await t(...e)}};var B=class j extends st{constructor(){super(...arguments),this._logger=new u(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{let t=this._expiration-j.getEpochTime();this._logger.debug("timer completes in",t),this._expiration<=j.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(t){let s=this._logger.create("init");t=Math.max(Math.floor(t),1);let r=j.getEpochTime()+t;if(this.expiration===r&&this._timerHandle){s.debug("skipping since already initialized for expiration at",this.expiration);return}this.cancel(),s.debug("using duration",t),this._expiration=r;let i=Math.min(t,5);this._timerHandle=setInterval(this._callback,i*1e3)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},_e=class{static readParams(e,t="query"){if(!e)throw new TypeError("Invalid URL");let r=new URL(e,"http://127.0.0.1")[t==="fragment"?"hash":"search"];return new URLSearchParams(r.slice(1))}},A=";",$=class extends Error{constructor(e,t){var s,r,i;if(super(e.error_description||e.error||""),this.form=t,this.name="ErrorResponse",!e.error)throw u.error("ErrorResponse","No error passed"),new Error("No error passed");this.error=e.error,this.error_description=(s=e.error_description)!=null?s:null,this.error_uri=(r=e.error_uri)!=null?r:null,this.state=e.userState,this.session_state=(i=e.session_state)!=null?i:null,this.url_state=e.url_state}},rt=class extends Error{constructor(e){super(e),this.name="ErrorTimeout"}};var it=class{constructor(){this._logger=new u("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(e){return this._logger.create(`getItem('${e}')`),this._data[e]}setItem(e,t){this._logger.create(`setItem('${e}')`),this._data[e]=t}removeItem(e){this._logger.create(`removeItem('${e}')`),delete this._data[e]}get length(){return Object.getOwnPropertyNames(this._data).length}key(e){return Object.getOwnPropertyNames(this._data)[e]}},Q=class extends Error{constructor(e,t){super(t),this.name="ErrorDPoPNonce",this.nonce=e}},ee=class{constructor(e=[],t=null,s={}){this._jwtHandler=t,this._extraHeaders=s,this._logger=new u("JsonService"),this._contentTypes=[],this._contentTypes.push(...e,"application/json"),t&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(e,t={}){let{timeoutInSeconds:s,...r}=t;if(!s)return await fetch(e,r);let i=new AbortController,n=setTimeout(()=>i.abort(),s*1e3);try{return await fetch(e,{...t,signal:i.signal})}catch(o){throw o instanceof DOMException&&o.name==="AbortError"?new rt("Network timed out"):o}finally{clearTimeout(n)}}async getJson(e,{token:t,credentials:s,timeoutInSeconds:r}={}){let i=this._logger.create("getJson"),n={Accept:this._contentTypes.join(", ")};t&&(i.debug("token passed, setting Authorization header"),n.Authorization="Bearer "+t),this._appendExtraHeaders(n);let o;try{i.debug("url:",e),o=await this.fetchWithTimeout(e,{method:"GET",headers:n,timeoutInSeconds:r,credentials:s})}catch(l){throw i.error("Network Error"),l}i.debug("HTTP response received, status",o.status);let a=o.headers.get("Content-Type");if(a&&!this._contentTypes.find(l=>a.startsWith(l))&&i.throw(new Error(`Invalid response Content-Type: ${a??"undefined"}, from URL: ${e}`)),o.ok&&this._jwtHandler&&a?.startsWith("application/jwt"))return await this._jwtHandler(await o.text());let c;try{c=await o.json()}catch(l){throw i.error("Error parsing JSON response",l),o.ok?l:new Error(`${o.statusText} (${o.status})`)}if(!o.ok)throw i.error("Error from server:",c),c.error?new $(c):new Error(`${o.statusText} (${o.status}): ${JSON.stringify(c)}`);return c}async postForm(e,{body:t,basicAuth:s,timeoutInSeconds:r,initCredentials:i,extraHeaders:n}){let o=this._logger.create("postForm"),a={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded",...n};s!==void 0&&(a.Authorization="Basic "+s),this._appendExtraHeaders(a);let c;try{o.debug("url:",e),c=await this.fetchWithTimeout(e,{method:"POST",headers:a,body:t,timeoutInSeconds:r,credentials:i})}catch(h){throw o.error("Network error"),h}o.debug("HTTP response received, status",c.status);let l=c.headers.get("Content-Type");if(l&&!this._contentTypes.find(h=>l.startsWith(h)))throw new Error(`Invalid response Content-Type: ${l??"undefined"}, from URL: ${e}`);let d=await c.text(),g={};if(d)try{g=JSON.parse(d)}catch(h){throw o.error("Error parsing JSON response",h),c.ok?h:new Error(`${c.statusText} (${c.status})`)}if(!c.ok){if(o.error("Error from server:",g),c.headers.has("dpop-nonce")){let h=c.headers.get("dpop-nonce");throw new Q(h,`${JSON.stringify(g)}`)}throw g.error?new $(g,t):new Error(`${c.statusText} (${c.status}): ${JSON.stringify(g)}`)}return g}_appendExtraHeaders(e){let t=this._logger.create("appendExtraHeaders"),s=Object.keys(this._extraHeaders),r=["accept","content-type"],i=["authorization"];s.length!==0&&s.forEach(n=>{if(r.includes(n.toLocaleLowerCase())){t.warn("Protected header could not be set",n,r);return}if(i.includes(n.toLocaleLowerCase())&&Object.keys(e).includes(n)){t.warn("Header could not be overridden",n,i);return}let o=typeof this._extraHeaders[n]=="function"?this._extraHeaders[n]():this._extraHeaders[n];o&&o!==""&&(e[n]=o)})}},nt=class{constructor(e){this._settings=e,this._logger=new u("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new ee(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){let e=this._logger.create("getMetadata");if(this._metadata)return e.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw e.throw(new Error("No authority or metadataUrl configured on settings")),null;e.debug("getting metadata from",this._metadataUrl);let t=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return e.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},t,this._settings.metadataSeed),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(e=!0){return this._getMetadataProperty("token_endpoint",e)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(e=!0){return this._getMetadataProperty("revocation_endpoint",e)}getKeysEndpoint(e=!0){return this._getMetadataProperty("jwks_uri",e)}async _getMetadataProperty(e,t=!1){let s=this._logger.create(`_getMetadataProperty('${e}')`),r=await this.getMetadata();if(s.debug("resolved"),r[e]===void 0){if(t===!0){s.warn("Metadata does not contain optional property");return}s.throw(new Error("Metadata does not contain property "+e))}return r[e]}async getSigningKeys(){let e=this._logger.create("getSigningKeys");if(this._signingKeys)return e.debug("returning signingKeys from cache"),this._signingKeys;let t=await this.getKeysEndpoint(!1);e.debug("got jwks_uri",t);let s=await this._jsonService.getJson(t,{timeoutInSeconds:this._settings.requestTimeoutInSeconds});if(e.debug("got key set",s),!Array.isArray(s.keys))throw e.throw(new Error("Missing keys on keyset")),null;return this._signingKeys=s.keys,this._signingKeys}},ot=class{constructor({prefix:e="oidc.",store:t=localStorage}={}){this._logger=new u("WebStorageStateStore"),this._store=t,this._prefix=e}async set(e,t){this._logger.create(`set('${e}')`),e=this._prefix+e,await this._store.setItem(e,t)}async get(e){return this._logger.create(`get('${e}')`),e=this._prefix+e,await this._store.getItem(e)}async remove(e){this._logger.create(`remove('${e}')`),e=this._prefix+e;let t=await this._store.getItem(e);return await this._store.removeItem(e),t}async getAllKeys(){this._logger.create("getAllKeys");let e=await this._store.length,t=[];for(let s=0;s<e;s++){let r=await this._store.key(s);r&&r.indexOf(this._prefix)===0&&t.push(r.substr(this._prefix.length))}return t}},at="code",ct="openid",lt="client_secret_post",dt=900,fe=class{constructor({authority:e,metadataUrl:t,metadata:s,signingKeys:r,metadataSeed:i,client_id:n,client_secret:o,response_type:a=at,scope:c=ct,redirect_uri:l,post_logout_redirect_uri:d,client_authentication:g=lt,prompt:h,display:_,max_age:N,ui_locales:q,acr_values:M,resource:D,response_mode:C,filterProtocolClaims:R=!0,loadUserInfo:H=!1,requestTimeoutInSeconds:b,staleStateAgeInSeconds:p=dt,mergeClaimsStrategy:x={array:"replace"},disablePKCE:P=!1,stateStore:w,revokeTokenAdditionalContentTypes:F,fetchRequestCredentials:ge,refreshTokenAllowedScope:Fe,extraQueryParams:je={},extraTokenParams:We={},extraHeaders:Le={},dpop:Be,omitScopeWhenRequesting:Je=!1}){var he;if(this.authority=e,t?this.metadataUrl=t:(this.metadataUrl=e,e&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=s,this.metadataSeed=i,this.signingKeys=r,this.client_id=n,this.client_secret=o,this.response_type=a,this.scope=c,this.redirect_uri=l,this.post_logout_redirect_uri=d,this.client_authentication=g,this.prompt=h,this.display=_,this.max_age=N,this.ui_locales=q,this.acr_values=M,this.resource=D,this.response_mode=C,this.filterProtocolClaims=R??!0,this.loadUserInfo=!!H,this.staleStateAgeInSeconds=p,this.mergeClaimsStrategy=x,this.omitScopeWhenRequesting=Je,this.disablePKCE=!!P,this.revokeTokenAdditionalContentTypes=F,this.fetchRequestCredentials=ge||"same-origin",this.requestTimeoutInSeconds=b,w)this.stateStore=w;else{let Ke=typeof window<"u"?window.localStorage:new it;this.stateStore=new ot({store:Ke})}if(this.refreshTokenAllowedScope=Fe,this.extraQueryParams=je,this.extraTokenParams=We,this.extraHeaders=Le,this.dpop=Be,this.dpop&&!((he=this.dpop)!=null&&he.store))throw new Error("A DPoPStore is required when dpop is enabled")}},gt=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new u("UserInfoService"),this._getClaimsFromJwt=async s=>{let r=this._logger.create("_getClaimsFromJwt");try{let i=L.decode(s);return r.debug("JWT decoding successful"),i}catch(i){throw r.error("Error parsing JWT response"),i}},this._jsonService=new ee(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(e){let t=this._logger.create("getClaims");e||this._logger.throw(new Error("No token passed"));let s=await this._metadataService.getUserInfoEndpoint();t.debug("got userinfo url",s);let r=await this._jsonService.getJson(s,{token:e,credentials:this._settings.fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return t.debug("got claims",r),r}},me=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new u("TokenClient"),this._jsonService=new ee(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:e="authorization_code",redirect_uri:t=this._settings.redirect_uri,client_id:s=this._settings.client_id,client_secret:r=this._settings.client_secret,extraHeaders:i,...n}){let o=this._logger.create("exchangeCode");s||o.throw(new Error("A client_id is required")),t||o.throw(new Error("A redirect_uri is required")),n.code||o.throw(new Error("A code is required"));let a=new URLSearchParams({grant_type:e,redirect_uri:t});for(let[g,h]of Object.entries(n))h!=null&&a.set(g,h);let c;switch(this._settings.client_authentication){case"client_secret_basic":if(r==null)throw o.throw(new Error("A client_secret is required")),null;c=f.generateBasicAuth(s,r);break;case"client_secret_post":a.append("client_id",s),r&&a.append("client_secret",r);break}let l=await this._metadataService.getTokenEndpoint(!1);o.debug("got token endpoint");let d=await this._jsonService.postForm(l,{body:a,basicAuth:c,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:i});return o.debug("got response"),d}async exchangeCredentials({grant_type:e="password",client_id:t=this._settings.client_id,client_secret:s=this._settings.client_secret,scope:r=this._settings.scope,...i}){let n=this._logger.create("exchangeCredentials");t||n.throw(new Error("A client_id is required"));let o=new URLSearchParams({grant_type:e});this._settings.omitScopeWhenRequesting||o.set("scope",r);for(let[d,g]of Object.entries(i))g!=null&&o.set(d,g);let a;switch(this._settings.client_authentication){case"client_secret_basic":if(s==null)throw n.throw(new Error("A client_secret is required")),null;a=f.generateBasicAuth(t,s);break;case"client_secret_post":o.append("client_id",t),s&&o.append("client_secret",s);break}let c=await this._metadataService.getTokenEndpoint(!1);n.debug("got token endpoint");let l=await this._jsonService.postForm(c,{body:o,basicAuth:a,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials});return n.debug("got response"),l}async exchangeRefreshToken({grant_type:e="refresh_token",client_id:t=this._settings.client_id,client_secret:s=this._settings.client_secret,timeoutInSeconds:r,extraHeaders:i,...n}){let o=this._logger.create("exchangeRefreshToken");t||o.throw(new Error("A client_id is required")),n.refresh_token||o.throw(new Error("A refresh_token is required"));let a=new URLSearchParams({grant_type:e});for(let[g,h]of Object.entries(n))Array.isArray(h)?h.forEach(_=>a.append(g,_)):h!=null&&a.set(g,h);let c;switch(this._settings.client_authentication){case"client_secret_basic":if(s==null)throw o.throw(new Error("A client_secret is required")),null;c=f.generateBasicAuth(t,s);break;case"client_secret_post":a.append("client_id",t),s&&a.append("client_secret",s);break}let l=await this._metadataService.getTokenEndpoint(!1);o.debug("got token endpoint");let d=await this._jsonService.postForm(l,{body:a,basicAuth:c,timeoutInSeconds:r,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:i});return o.debug("got response"),d}async revoke(e){var t;let s=this._logger.create("revoke");e.token||s.throw(new Error("A token is required"));let r=await this._metadataService.getRevocationEndpoint(!1);s.debug(`got revocation endpoint, revoking ${(t=e.token_type_hint)!=null?t:"default token type"}`);let i=new URLSearchParams;for(let[n,o]of Object.entries(e))o!=null&&i.set(n,o);i.set("client_id",this._settings.client_id),this._settings.client_secret&&i.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(r,{body:i,timeoutInSeconds:this._settings.requestTimeoutInSeconds}),s.debug("got response")}},ht=class{constructor(e,t,s){this._settings=e,this._metadataService=t,this._claimsService=s,this._logger=new u("ResponseValidator"),this._userInfoService=new gt(this._settings,this._metadataService),this._tokenClient=new me(this._settings,this._metadataService)}async validateSigninResponse(e,t,s){let r=this._logger.create("validateSigninResponse");this._processSigninState(e,t),r.debug("state processed"),await this._processCode(e,t,s),r.debug("code processed"),e.isOpenId&&this._validateIdTokenAttributes(e),r.debug("tokens validated"),await this._processClaims(e,t?.skipUserInfo,e.isOpenId),r.debug("claims processed")}async validateCredentialsResponse(e,t){let s=this._logger.create("validateCredentialsResponse"),r=e.isOpenId&&!!e.id_token;r&&this._validateIdTokenAttributes(e),s.debug("tokens validated"),await this._processClaims(e,t,r),s.debug("claims processed")}async validateRefreshResponse(e,t){var s,r;let i=this._logger.create("validateRefreshResponse");e.userState=t.data,(s=e.session_state)!=null||(e.session_state=t.session_state),(r=e.scope)!=null||(e.scope=t.scope),e.isOpenId&&e.id_token&&(this._validateIdTokenAttributes(e,t.id_token),i.debug("ID Token validated")),e.id_token||(e.id_token=t.id_token,e.profile=t.profile);let n=e.isOpenId&&!!e.id_token;await this._processClaims(e,!1,n),i.debug("claims processed")}validateSignoutResponse(e,t){let s=this._logger.create("validateSignoutResponse");if(t.id!==e.state&&s.throw(new Error("State does not match")),s.debug("state validated"),e.userState=t.data,e.error)throw s.warn("Response was error",e.error),new $(e)}_processSigninState(e,t){var s;let r=this._logger.create("_processSigninState");if(t.id!==e.state&&r.throw(new Error("State does not match")),t.client_id||r.throw(new Error("No client_id on state")),t.authority||r.throw(new Error("No authority on state")),this._settings.authority!==t.authority&&r.throw(new Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==t.client_id&&r.throw(new Error("client_id mismatch on settings vs. signin state")),r.debug("state validated"),e.userState=t.data,e.url_state=t.url_state,(s=e.scope)!=null||(e.scope=t.scope),e.error)throw r.warn("Response was error",e.error),new $(e);t.code_verifier&&!e.code&&r.throw(new Error("Expected code in response"))}async _processClaims(e,t=!1,s=!0){let r=this._logger.create("_processClaims");if(e.profile=this._claimsService.filterProtocolClaims(e.profile),t||!this._settings.loadUserInfo||!e.access_token){r.debug("not loading user info");return}r.debug("loading user info");let i=await this._userInfoService.getClaims(e.access_token);r.debug("user info claims received from user info endpoint"),s&&i.sub!==e.profile.sub&&r.throw(new Error("subject from UserInfo response does not match subject in ID Token")),e.profile=this._claimsService.mergeClaims(e.profile,this._claimsService.filterProtocolClaims(i)),r.debug("user info claims received, updated profile:",e.profile)}async _processCode(e,t,s){let r=this._logger.create("_processCode");if(e.code){r.debug("Validating code");let i=await this._tokenClient.exchangeCode({client_id:t.client_id,client_secret:t.client_secret,code:e.code,redirect_uri:t.redirect_uri,code_verifier:t.code_verifier,extraHeaders:s,...t.extraTokenParams});Object.assign(e,i)}else r.debug("No code to process")}_validateIdTokenAttributes(e,t){var s;let r=this._logger.create("_validateIdTokenAttributes");r.debug("decoding ID Token JWT");let i=L.decode((s=e.id_token)!=null?s:"");if(i.sub||r.throw(new Error("ID Token is missing a subject claim")),t){let n=L.decode(t);i.sub!==n.sub&&r.throw(new Error("sub in id_token does not match current sub")),i.auth_time&&i.auth_time!==n.auth_time&&r.throw(new Error("auth_time in id_token does not match original auth_time")),i.azp&&i.azp!==n.azp&&r.throw(new Error("azp in id_token does not match original azp")),!i.azp&&n.azp&&r.throw(new Error("azp not in id_token, but present in original id_token"))}e.profile=i}},J=class Y{constructor(t){this.id=t.id||f.generateUUIDv4(),this.data=t.data,t.created&&t.created>0?this.created=t.created:this.created=B.getEpochTime(),this.request_type=t.request_type,this.url_state=t.url_state}toStorageString(){return new u("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(t){return u.createStatic("State","fromStorageString"),Promise.resolve(new Y(JSON.parse(t)))}static async clearStaleState(t,s){let r=u.createStatic("State","clearStaleState"),i=B.getEpochTime()-s,n=await t.getAllKeys();r.debug("got keys",n);for(let o=0;o<n.length;o++){let a=n[o],c=await t.get(a),l=!1;if(c)try{let d=await Y.fromStorageString(c);r.debug("got item from key:",a,d.created),d.created<=i&&(l=!0)}catch(d){r.error("Error parsing state for key:",a,d),l=!0}else r.debug("no item in storage for key:",a),l=!0;l&&(r.debug("removed item for key:",a),t.remove(a))}}},Se=class Z extends J{constructor(t){super(t),this.code_verifier=t.code_verifier,this.code_challenge=t.code_challenge,this.authority=t.authority,this.client_id=t.client_id,this.redirect_uri=t.redirect_uri,this.scope=t.scope,this.client_secret=t.client_secret,this.extraTokenParams=t.extraTokenParams,this.response_mode=t.response_mode,this.skipUserInfo=t.skipUserInfo}static async create(t){let s=t.code_verifier===!0?f.generateCodeVerifier():t.code_verifier||void 0,r=s?await f.generateCodeChallenge(s):void 0;return new Z({...t,code_verifier:s,code_challenge:r})}toStorageString(){return new u("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(t){u.createStatic("SigninState","fromStorageString");let s=JSON.parse(t);return Z.create(s)}},ve=class ye{constructor(t){this.url=t.url,this.state=t.state}static async create({url:t,authority:s,client_id:r,redirect_uri:i,response_type:n,scope:o,state_data:a,response_mode:c,request_type:l,client_secret:d,nonce:g,url_state:h,resource:_,skipUserInfo:N,extraQueryParams:q,extraTokenParams:M,disablePKCE:D,dpopJkt:C,omitScopeWhenRequesting:R,...H}){if(!t)throw this._logger.error("create: No url passed"),new Error("url");if(!r)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!i)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!n)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!o)throw this._logger.error("create: No scope passed"),new Error("scope");if(!s)throw this._logger.error("create: No authority passed"),new Error("authority");let b=await Se.create({data:a,request_type:l,url_state:h,code_verifier:!D,client_id:r,authority:s,redirect_uri:i,response_mode:c,client_secret:d,scope:o,extraTokenParams:M,skipUserInfo:N}),p=new URL(t);p.searchParams.append("client_id",r),p.searchParams.append("redirect_uri",i),p.searchParams.append("response_type",n),R||p.searchParams.append("scope",o),g&&p.searchParams.append("nonce",g),C&&p.searchParams.append("dpop_jkt",C);let x=b.id;h&&(x=`${x}${A}${h}`),p.searchParams.append("state",x),b.code_challenge&&(p.searchParams.append("code_challenge",b.code_challenge),p.searchParams.append("code_challenge_method","S256")),_&&(Array.isArray(_)?_:[_]).forEach(w=>p.searchParams.append("resource",w));for(let[P,w]of Object.entries({response_mode:c,...H,...q}))w!=null&&p.searchParams.append(P,w.toString());return new ye({url:p.href,state:b})}};ve._logger=new u("SigninRequest");var ut=ve,pt="openid",G=class{constructor(e){if(this.access_token="",this.token_type="",this.profile={},this.state=e.get("state"),this.session_state=e.get("session_state"),this.state){let t=decodeURIComponent(this.state).split(A);this.state=t[0],t.length>1&&(this.url_state=t.slice(1).join(A))}this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri"),this.code=e.get("code")}get expires_in(){if(this.expires_at!==void 0)return this.expires_at-B.getEpochTime()}set expires_in(e){typeof e=="string"&&(e=Number(e)),e!==void 0&&e>=0&&(this.expires_at=Math.floor(e)+B.getEpochTime())}get isOpenId(){var e;return((e=this.scope)==null?void 0:e.split(" ").includes(pt))||!!this.id_token}},_t=class{constructor({url:e,state_data:t,id_token_hint:s,post_logout_redirect_uri:r,extraQueryParams:i,request_type:n,client_id:o,url_state:a}){if(this._logger=new u("SignoutRequest"),!e)throw this._logger.error("ctor: No url passed"),new Error("url");let c=new URL(e);if(s&&c.searchParams.append("id_token_hint",s),o&&c.searchParams.append("client_id",o),r&&(c.searchParams.append("post_logout_redirect_uri",r),t||a)){this.state=new J({data:t,request_type:n,url_state:a});let l=this.state.id;a&&(l=`${l}${A}${a}`),c.searchParams.append("state",l)}for(let[l,d]of Object.entries({...i}))d!=null&&c.searchParams.append(l,d.toString());this.url=c.href}},ft=class{constructor(e){if(this.state=e.get("state"),this.state){let t=decodeURIComponent(this.state).split(A);this.state=t[0],t.length>1&&(this.url_state=t.slice(1).join(A))}this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri")}},wt=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],mt=["sub","iss","aud","exp","iat"],St=class{constructor(e){this._settings=e,this._logger=new u("ClaimsService")}filterProtocolClaims(e){let t={...e};if(this._settings.filterProtocolClaims){let s;Array.isArray(this._settings.filterProtocolClaims)?s=this._settings.filterProtocolClaims:s=wt;for(let r of s)mt.includes(r)||delete t[r]}return t}mergeClaims(e,t){let s={...e};for(let[r,i]of Object.entries(t))if(s[r]!==i)if(Array.isArray(s[r])||Array.isArray(i))if(this._settings.mergeClaimsStrategy.array=="replace")s[r]=i;else{let n=Array.isArray(s[r])?s[r]:[s[r]];for(let o of Array.isArray(i)?i:[i])n.includes(o)||n.push(o);s[r]=n}else typeof s[r]=="object"&&typeof i=="object"?s[r]=this.mergeClaims(s[r],i):s[r]=i;return s}},vt=class{constructor(e,t){this.keys=e,this.nonce=t}},be=class{constructor(e,t){this._logger=new u("OidcClient"),this.settings=e instanceof fe?e:new fe(e),this.metadataService=t??new nt(this.settings),this._claimsService=new St(this.settings),this._validator=new ht(this.settings,this.metadataService,this._claimsService),this._tokenClient=new me(this.settings,this.metadataService)}async createSigninRequest({state:e,request:t,request_uri:s,request_type:r,id_token_hint:i,login_hint:n,skipUserInfo:o,nonce:a,url_state:c,response_type:l=this.settings.response_type,scope:d=this.settings.scope,redirect_uri:g=this.settings.redirect_uri,prompt:h=this.settings.prompt,display:_=this.settings.display,max_age:N=this.settings.max_age,ui_locales:q=this.settings.ui_locales,acr_values:M=this.settings.acr_values,resource:D=this.settings.resource,response_mode:C=this.settings.response_mode,extraQueryParams:R=this.settings.extraQueryParams,extraTokenParams:H=this.settings.extraTokenParams,dpopJkt:b,omitScopeWhenRequesting:p=this.settings.omitScopeWhenRequesting}){let x=this._logger.create("createSigninRequest");if(l!=="code")throw new Error("Only the Authorization Code flow (with PKCE) is supported");let P=await this.metadataService.getAuthorizationEndpoint();x.debug("Received authorization endpoint",P);let w=await ut.create({url:P,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:g,response_type:l,scope:d,state_data:e,url_state:c,prompt:h,display:_,max_age:N,ui_locales:q,id_token_hint:i,login_hint:n,acr_values:M,dpopJkt:b,resource:D,request:t,request_uri:s,extraQueryParams:R,extraTokenParams:H,request_type:r,response_mode:C,client_secret:this.settings.client_secret,skipUserInfo:o,nonce:a,disablePKCE:this.settings.disablePKCE,omitScopeWhenRequesting:p});await this.clearStaleState();let F=w.state;return await this.settings.stateStore.set(F.id,F.toStorageString()),w}async readSigninResponseState(e,t=!1){let s=this._logger.create("readSigninResponseState"),r=new G(_e.readParams(e,this.settings.response_mode));if(!r.state)throw s.throw(new Error("No state in response")),null;let i=await this.settings.stateStore[t?"remove":"get"](r.state);if(!i)throw s.throw(new Error("No matching state found in storage")),null;return{state:await Se.fromStorageString(i),response:r}}async processSigninResponse(e,t,s=!0){let r=this._logger.create("processSigninResponse"),{state:i,response:n}=await this.readSigninResponseState(e,s);if(r.debug("received state from storage; validating response"),this.settings.dpop&&this.settings.dpop.store){let o=await this.getDpopProof(this.settings.dpop.store);t={...t,DPoP:o}}try{await this._validator.validateSigninResponse(n,i,t)}catch(o){if(o instanceof Q&&this.settings.dpop){let a=await this.getDpopProof(this.settings.dpop.store,o.nonce);t.DPoP=a,await this._validator.validateSigninResponse(n,i,t)}else throw o}return n}async getDpopProof(e,t){let s,r;return(await e.getAllKeys()).includes(this.settings.client_id)?(r=await e.get(this.settings.client_id),r.nonce!==t&&t&&(r.nonce=t,await e.set(this.settings.client_id,r))):(s=await f.generateDPoPKeys(),r=new vt(s,t),await e.set(this.settings.client_id,r)),await f.generateDPoPProof({url:await this.metadataService.getTokenEndpoint(!1),httpMethod:"POST",keyPair:r.keys,nonce:r.nonce})}async processResourceOwnerPasswordCredentials({username:e,password:t,skipUserInfo:s=!1,extraTokenParams:r={}}){let i=await this._tokenClient.exchangeCredentials({username:e,password:t,...r}),n=new G(new URLSearchParams);return Object.assign(n,i),await this._validator.validateCredentialsResponse(n,s),n}async useRefreshToken({state:e,redirect_uri:t,resource:s,timeoutInSeconds:r,extraHeaders:i,extraTokenParams:n}){var o;let a=this._logger.create("useRefreshToken"),c;if(this.settings.refreshTokenAllowedScope===void 0)c=e.scope;else{let g=this.settings.refreshTokenAllowedScope.split(" ");c=(((o=e.scope)==null?void 0:o.split(" "))||[]).filter(_=>g.includes(_)).join(" ")}if(this.settings.dpop&&this.settings.dpop.store){let g=await this.getDpopProof(this.settings.dpop.store);i={...i,DPoP:g}}let l;try{l=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token,scope:c,redirect_uri:t,resource:s,timeoutInSeconds:r,extraHeaders:i,...n})}catch(g){if(g instanceof Q&&this.settings.dpop)i.DPoP=await this.getDpopProof(this.settings.dpop.store,g.nonce),l=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token,scope:c,redirect_uri:t,resource:s,timeoutInSeconds:r,extraHeaders:i,...n});else throw g}let d=new G(new URLSearchParams);return Object.assign(d,l),a.debug("validating response",d),await this._validator.validateRefreshResponse(d,{...e,scope:c}),d}async createSignoutRequest({state:e,id_token_hint:t,client_id:s,request_type:r,url_state:i,post_logout_redirect_uri:n=this.settings.post_logout_redirect_uri,extraQueryParams:o=this.settings.extraQueryParams}={}){let a=this._logger.create("createSignoutRequest"),c=await this.metadataService.getEndSessionEndpoint();if(!c)throw a.throw(new Error("No end session endpoint")),null;a.debug("Received end session endpoint",c),!s&&n&&!t&&(s=this.settings.client_id);let l=new _t({url:c,id_token_hint:t,client_id:s,post_logout_redirect_uri:n,state_data:e,extraQueryParams:o,request_type:r,url_state:i});await this.clearStaleState();let d=l.state;return d&&(a.debug("Signout request has state to persist"),await this.settings.stateStore.set(d.id,d.toStorageString())),l}async readSignoutResponseState(e,t=!1){let s=this._logger.create("readSignoutResponseState"),r=new ft(_e.readParams(e,this.settings.response_mode));if(!r.state){if(s.debug("No state in response"),r.error)throw s.warn("Response was error:",r.error),new $(r);return{state:void 0,response:r}}let i=await this.settings.stateStore[t?"remove":"get"](r.state);if(!i)throw s.throw(new Error("No matching state found in storage")),null;return{state:await J.fromStorageString(i),response:r}}async processSignoutResponse(e){let t=this._logger.create("processSignoutResponse"),{state:s,response:r}=await this.readSignoutResponseState(e,!0);return s?(t.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(r,s)):t.debug("No state from storage; skipping response validation"),r}clearStaleState(){return this._logger.create("clearStaleState"),J.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(e,t){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:e,token_type_hint:t})}};import Oe from"node:process";import{Buffer as Ne}from"node:buffer";import qe from"node:path";import{fileURLToPath as Kt}from"node:url";import{promisify as zt}from"node:util";import Me from"node:child_process";import Vt,{constants as Gt}from"node:fs/promises";import Pe from"node:process";import Te,{constants as Tt}from"node:fs/promises";import xe from"node:process";import xt from"node:os";import Pt from"node:fs";import kt from"node:fs";import ke from"node:fs";var te;function yt(){try{return ke.statSync("/.dockerenv"),!0}catch{return!1}}function bt(){try{return ke.readFileSync("/proc/self/cgroup","utf8").includes("docker")}catch{return!1}}function se(){return te===void 0&&(te=yt()||bt()),te}var re,Et=()=>{try{return kt.statSync("/run/.containerenv"),!0}catch{return!1}};function U(){return re===void 0&&(re=Et()||se()),re}var Ee=()=>{if(xe.platform!=="linux")return!1;if(xt.release().toLowerCase().includes("microsoft"))return!U();try{return Pt.readFileSync("/proc/version","utf8").toLowerCase().includes("microsoft")?!U():!1}catch{return!1}},k=xe.env.__IS_WSL_TEST__?Ee:Ee();var It=(()=>{let e="/mnt/",t;return async function(){if(t)return t;let s="/etc/wsl.conf",r=!1;try{await Te.access(s,Tt.F_OK),r=!0}catch{}if(!r)return e;let i=await Te.readFile(s,{encoding:"utf8"}),n=/(?<!#.*)root\s*=\s*(?<mountPoint>.*)/g.exec(i);return n?(t=n.groups.mountPoint.trim(),t=t.endsWith("/")?t:`${t}/`,t):e}})(),Ct=async()=>`${await It()}c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe`,ie=async()=>k?Ct():`${Pe.env.SYSTEMROOT||Pe.env.windir||String.raw`C:\Windows`}\\System32\\WindowsPowerShell\\v1.0\\powershell.exe`;function E(e,t,s){let r=i=>Object.defineProperty(e,t,{value:i,enumerable:!0,writable:!0});return Object.defineProperty(e,t,{configurable:!0,enumerable:!0,get(){let i=s();return r(i),i},set(i){r(i)}}),e}import{promisify as Wt}from"node:util";import ce from"node:process";import{execFile as Lt}from"node:child_process";import{promisify as Rt}from"node:util";import At from"node:process";import{execFile as Ut}from"node:child_process";var Ot=Rt(Ut);async function ne(){if(At.platform!=="darwin")throw new Error("macOS only");let{stdout:e}=await Ot("defaults",["read","com.apple.LaunchServices/com.apple.launchservices.secure","LSHandlers"]);return/LSHandlerRoleAll = "(?!-)(?<id>[^"]+?)";\s+?LSHandlerURLScheme = (?:http|https);/.exec(e)?.groups.id??"com.apple.Safari"}import Nt from"node:process";import{promisify as qt}from"node:util";import{execFile as Mt,execFileSync as Ys}from"node:child_process";var Dt=qt(Mt);async function Ie(e,{humanReadableOutput:t=!0}={}){if(Nt.platform!=="darwin")throw new Error("macOS only");let s=t?[]:["-ss"],{stdout:r}=await Dt("osascript",["-e",e,s]);return r.trim()}async function oe(e){return Ie(`tell application "Finder" to set app_path to application file id "${e}" as string
tell application "System Events" to get value of property list item "CFBundleName" of property list file (app_path & ":Contents:Info.plist")`)}import{promisify as Ht}from"node:util";import{execFile as $t}from"node:child_process";var Ft=Ht($t),jt={AppXq0fevzme2pys62n3e0fbqa7peapykr8v:{name:"Edge",id:"com.microsoft.edge.old"},MSEdgeDHTML:{name:"Edge",id:"com.microsoft.edge"},MSEdgeHTM:{name:"Edge",id:"com.microsoft.edge"},"IE.HTTP":{name:"Internet Explorer",id:"com.microsoft.ie"},FirefoxURL:{name:"Firefox",id:"org.mozilla.firefox"},ChromeHTML:{name:"Chrome",id:"com.google.chrome"},BraveHTML:{name:"Brave",id:"com.brave.Browser"},BraveBHTML:{name:"Brave Beta",id:"com.brave.Browser.beta"},BraveSSHTM:{name:"Brave Nightly",id:"com.brave.Browser.nightly"}},K=class extends Error{};async function ae(e=Ft){let{stdout:t}=await e("reg",["QUERY"," HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\Shell\\Associations\\UrlAssociations\\http\\UserChoice","/v","ProgId"]),s=/ProgId\s*REG_SZ\s*(?<id>\S+)/.exec(t);if(!s)throw new K(`Cannot find Windows browser in stdout: ${JSON.stringify(t)}`);let{id:r}=s.groups,i=jt[r];if(!i)throw new K(`Unknown browser ID: ${r}`);return i}var Bt=Wt(Lt),Jt=e=>e.toLowerCase().replaceAll(/(?:^|\s|-)\S/g,t=>t.toUpperCase());async function le(){if(ce.platform==="darwin"){let e=await ne();return{name:await oe(e),id:e}}if(ce.platform==="linux"){let{stdout:e}=await Bt("xdg-mime",["query","default","x-scheme-handler/http"]),t=e.trim();return{name:Jt(t.replace(/.desktop$/,"").replace("-"," ")),id:t}}if(ce.platform==="win32")return ae();throw new Error("Only macOS, Linux, and Windows are supported")}var Xt=zt(Me.execFile),de=qe.dirname(Kt(import.meta.url)),Ce=qe.join(de,"xdg-open"),{platform:O,arch:Re}=Oe;async function Qt(){let e=await ie(),t=String.raw`(Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\Shell\Associations\UrlAssociations\http\UserChoice").ProgId`,s=Ne.from(t,"utf16le").toString("base64"),{stdout:r}=await Xt(e,["-NoProfile","-NonInteractive","-ExecutionPolicy","Bypass","-EncodedCommand",s],{encoding:"utf8"}),i=r.trim(),n={ChromeHTML:"com.google.chrome",BraveHTML:"com.brave.Browser",MSEdgeHTM:"com.microsoft.edge",FirefoxURL:"org.mozilla.firefox"};return n[i]?{id:n[i]}:{}}var Ae=async(e,t)=>{let s;for(let r of e)try{return await t(r)}catch(i){s=i}throw s},z=async e=>{if(e={wait:!1,background:!1,newInstance:!1,allowNonzeroExitCode:!1,...e},Array.isArray(e.app))return Ae(e.app,a=>z({...e,app:a}));let{name:t,arguments:s=[]}=e.app??{};if(s=[...s],Array.isArray(t))return Ae(t,a=>z({...e,app:{name:a,arguments:s}}));if(t==="browser"||t==="browserPrivate"){let a={"com.google.chrome":"chrome","google-chrome.desktop":"chrome","com.brave.Browser":"brave","org.mozilla.firefox":"firefox","firefox.desktop":"firefox","com.microsoft.msedge":"edge","com.microsoft.edge":"edge","com.microsoft.edgemac":"edge","microsoft-edge.desktop":"edge"},c={chrome:"--incognito",brave:"--incognito",firefox:"--private-window",edge:"--inPrivate"},l=k?await Qt():await le();if(l.id in a){let d=a[l.id];return t==="browserPrivate"&&s.push(c[d]),z({...e,app:{name:I[d],arguments:s}})}throw new Error(`${l.name} is not supported as a default browser`)}let r,i=[],n={};if(O==="darwin")r="open",e.wait&&i.push("--wait-apps"),e.background&&i.push("--background"),e.newInstance&&i.push("--new"),t&&i.push("-a",t);else if(O==="win32"||k&&!U()&&!t){r=await ie(),i.push("-NoProfile","-NonInteractive","-ExecutionPolicy","Bypass","-EncodedCommand"),k||(n.windowsVerbatimArguments=!0);let a=["Start"];e.wait&&a.push("-Wait"),t?(a.push(`"\`"${t}\`""`),e.target&&s.push(e.target)):e.target&&a.push(`"${e.target}"`),s.length>0&&(s=s.map(c=>`"\`"${c}\`""`),a.push("-ArgumentList",s.join(","))),e.target=Ne.from(a.join(" "),"utf16le").toString("base64")}else{if(t)r=t;else{let a=!de||de==="/",c=!1;try{await Vt.access(Ce,Gt.X_OK),c=!0}catch{}r=Oe.versions.electron??(O==="android"||a||!c)?"xdg-open":Ce}s.length>0&&i.push(...s),e.wait||(n.stdio="ignore",n.detached=!0)}O==="darwin"&&s.length>0&&i.push("--args",...s),e.target&&i.push(e.target);let o=Me.spawn(r,i,n);return e.wait?new Promise((a,c)=>{o.once("error",c),o.once("close",l=>{if(!e.allowNonzeroExitCode&&l>0){c(new Error(`Exited with code ${l}`));return}a(o)})}):(o.unref(),o)},Yt=(e,t)=>{if(typeof e!="string")throw new TypeError("Expected a `target`");return z({...t,target:e})};function Ue(e){if(typeof e=="string"||Array.isArray(e))return e;let{[Re]:t}=e;if(!t)throw new Error(`${Re} is not supported`);return t}function V({[O]:e},{wsl:t}){if(t&&k)return Ue(t);if(!e)throw new Error(`${O} is not supported`);return Ue(e)}var I={};E(I,"chrome",()=>V({darwin:"google chrome",win32:"chrome",linux:["google-chrome","google-chrome-stable","chromium"]},{wsl:{ia32:"/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe",x64:["/mnt/c/Program Files/Google/Chrome/Application/chrome.exe","/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe"]}}));E(I,"brave",()=>V({darwin:"brave browser",win32:"brave",linux:["brave-browser","brave"]},{wsl:{ia32:"/mnt/c/Program Files (x86)/BraveSoftware/Brave-Browser/Application/brave.exe",x64:["/mnt/c/Program Files/BraveSoftware/Brave-Browser/Application/brave.exe","/mnt/c/Program Files (x86)/BraveSoftware/Brave-Browser/Application/brave.exe"]}}));E(I,"firefox",()=>V({darwin:"firefox",win32:String.raw`C:\Program Files\Mozilla Firefox\firefox.exe`,linux:"firefox"},{wsl:"/mnt/c/Program Files/Mozilla Firefox/firefox.exe"}));E(I,"edge",()=>V({darwin:"microsoft edge",win32:"msedge",linux:["microsoft-edge","microsoft-edge-dev"]},{wsl:"/mnt/c/Program Files (x86)/Microsoft/Edge/Application/msedge.exe"}));E(I,"browser",()=>"browser");E(I,"browserPrivate",()=>"browserPrivate");var De=Yt;async function He({clientId:e,clientSecret:t,port:s}){let r=new be({authority:"https://accounts.google.com",client_id:e,client_secret:t,redirect_uri:`http://127.0.0.1:${s}/callback`}),i=await r.createSigninRequest({});await De(i.url);let n={data:void 0},o=es(s,n);for(;!n.data;)await ts(500);o.close(),console.log(n.data);let a=await r.processSigninResponse(n.data);console.log(a)}function es(e,t){return Zt(async(r,i)=>{console.log("request: ",r.url),i.statusCode=200,t.data=`http://127.0.0.1:${e}${r.url}`,i.end()}).listen(e,()=>{})}function ts(e){return new Promise(t=>setTimeout(t,e))}async function $e(e){let t=ue(e);return t.error?(console.error(t.error),1):(await He({clientId:t.oidcClientId,clientSecret:t.clientSecret,port:t.port}),0)}$e(ss.slice(2)).then(e=>{e!==0&&process.exit(e)});
//# sourceMappingURL=cli.js.map
